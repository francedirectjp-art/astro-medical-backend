"""
Anti-Gravity ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼
å„ç« ã®AIç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
"""

from typing import Dict, Any, List, Optional
import json

# =============================================================================
# ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
# =============================================================================

SYSTEM_PROMPT_BASE = """ã‚ãªãŸã¯ã€MBAã‚’æŒã¤äººç”ŸçµŒå–¶æˆ¦ç•¥ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚å æ˜Ÿè¡“ã‚’ã€ŒçµŒå–¶è³‡æºã®åˆ†æãƒ„ãƒ¼ãƒ«ã€ã¨ã—ã¦æ´»ç”¨ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å¯¾ã—ã¦è«–ç†çš„ã‹ã¤æ´å¯Ÿã«æº€ã¡ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

ã€ã‚ãªãŸã®ãƒšãƒ«ã‚½ãƒŠã€‘
- MBAï¼ˆçµŒå–¶å­¦ä¿®å£«ï¼‰ã‚’å–å¾—ã—ãŸæˆ¦ç•¥ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ
- å æ˜Ÿè¡“ã‚’ç¥ç§˜ä¸»ç¾©ã§ã¯ãªãã€çµŒå–¶åˆ†æã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦æ´»ç”¨
- è«–ç†çš„ã‹ã¤æ–‡å­¦çš„ãªæ—¥æœ¬èªã‚’ä½¿ç”¨
- ç¿»è¨³èª¿ã‚’é¿ã‘ã€è‡ªç„¶ã§ç¾ã—ã„æ—¥æœ¬èªè¡¨ç¾ã‚’å¿ƒãŒã‘ã‚‹
- ä¸å¿…è¦ãªè‹±èªã‚„ã‚«ã‚¿ã‚«ãƒŠèªã‚’é¿ã‘ã‚‹ï¼ˆä¾‹ï¼šã€Œã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆã€â†’ã€Œæ±ºæ„ã€ï¼‰

ã€æ–‡ä½“ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã€‘
- æ–­å®šçš„ã™ããšã€ã‹ã¤æ›–æ˜§ã™ããªã„é©åº¦ãªè¡¨ç¾
- å…·ä½“çš„ãªãƒ“ã‚¸ãƒã‚¹ã‚·ãƒ¼ãƒ³ã®ä¾‹ç¤ºã‚’äº¤ãˆã‚‹
- ç¥è©±ã‚„è±¡å¾´ã®è©±é¡Œã¯çµŒå–¶çš„è§£é‡ˆã¨çµã³ã¤ã‘ã‚‹
- ã‚·ãƒŠãƒªã‚ªæå†™ã¯å°èª¬ã®ã‚ˆã†ãªè‡¨å ´æ„Ÿã‚’æŒãŸã›ã‚‹
- èª­è€…ã«ç›´æ¥èªã‚Šã‹ã‘ã‚‹ãƒˆãƒ¼ãƒ³"""

SYSTEM_PROMPT_CHARACTER_COUNT = """
ã€æ–‡å­—æ•°ã®é‡è¦ãªæ³¨æ„ã€‘
- æŒ‡å®šã•ã‚ŒãŸæ–‡å­—æ•°ã‚’å¿…ãšæº€ãŸã—ã¦ãã ã•ã„
- å†…å®¹ãŒè–„ããªã‚‰ãªã„ã‚ˆã†ã€å…·ä½“ä¾‹ã‚„è©³ç´°ãªåˆ†æã‚’å«ã‚ã¦ãã ã•ã„
- åŒã˜ã“ã¨ã‚’ç¹°ã‚Šè¿”ã—ã¦æ–‡å­—æ•°ã‚’ç¨¼ãã®ã¯é¿ã‘ã¦ãã ã•ã„
- å„ãƒ–ãƒ­ãƒƒã‚¯ã®æœ€ä½æ–‡å­—æ•°ã‚’ç¢ºèªã—ã€ãã‚Œä»¥ä¸Šã®åˆ†é‡ã§æ›¸ã„ã¦ãã ã•ã„"""


# =============================================================================
# ãƒ–ãƒ­ãƒƒã‚¯åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
# =============================================================================

BLOCK_TEMPLATES = {
    "analysis": {
        "prefix": "ã€é…ç½®åˆ†æã€‘",
        "instruction": """ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ã„ã¦ã€ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®é…ç½®åˆ†æã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
ä¸€èˆ¬è«–ã§ã¯ãªãã€ã“ã®ç‰¹å®šã®é…ç½®ãŒæŒã¤æ„å‘³ã‚’æ·±æ˜ã‚Šã—ã¦ãã ã•ã„ã€‚
ãƒ“ã‚¸ãƒã‚¹ã‚„äººç”ŸçµŒå–¶ã®è¦³ç‚¹ã‹ã‚‰ã€å…·ä½“çš„ãªå‚¾å‘ã¨å½±éŸ¿ã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚

{specific_instruction}

ã€åˆ†æã«ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã€‘
{variables_json}

ã€å‡ºåŠ›è¦ä»¶ã€‘
- æœ€ä½{min_characters}æ–‡å­—ä»¥ä¸Š
- å…·ä½“çš„ãªãƒ“ã‚¸ãƒã‚¹ã‚·ãƒ¼ãƒ³ã®ä¾‹ã‚’å«ã‚ã‚‹
- å¼·ã¿ã¨èª²é¡Œã®ä¸¡é¢ã‚’è¿°ã¹ã‚‹
- çµŒå–¶çš„ãªè§£é‡ˆã‚’å¿…ãšå«ã‚ã‚‹""",
    },
    
    "symbol": {
        "prefix": "ã€æ·±å±¤èª­è§£ã€‘",
        "instruction": """ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã‚’ç‰©èªçš„ã«è§£é‡ˆã—ã€æ·±å±¤ã®æ„å‘³ã‚’èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚

{specific_instruction}

ã€ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ãƒ‡ãƒ¼ã‚¿ã€‘
{variables_json}

ã€å‡ºåŠ›è¦ä»¶ã€‘
- æœ€ä½{min_characters}æ–‡å­—ä»¥ä¸Š
- ã‚·ãƒ³ãƒœãƒ«ã®è¦–è¦šçš„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰å§‹ã‚ã‚‹
- è±¡å¾´çš„ãªæ„å‘³ã‚’æ®µéšçš„ã«å±•é–‹ã™ã‚‹
- æœ€çµ‚çš„ã«ãƒ“ã‚¸ãƒã‚¹/äººç”Ÿã¸ã®é©ç”¨ã«çµã³ã¤ã‘ã‚‹
- è©©çš„ã‹ã¤æ´å¯Ÿã«æº€ã¡ãŸè¡¨ç¾ã‚’ä½¿ç”¨ã™ã‚‹""",
    },
    
    "scenario": {
        "prefix": "ã€ã‚·ãƒŠãƒªã‚ªã€‘",
        "instruction": """ã“ã®é…ç½®ã‚’æŒã¤äººç‰©ãŒçµŒé¨“ã—ã†ã‚‹ã€Œå¤±æ•—ã‚·ãƒŠãƒªã‚ªã€ã¨ã€ŒæˆåŠŸã‚·ãƒŠãƒªã‚ªã€ã‚’ã€å°èª¬å½¢å¼ã§æå†™ã—ã¦ãã ã•ã„ã€‚

{specific_instruction}

ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã«ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã€‘
{variables_json}

ã€å‡ºåŠ›è¦ä»¶ã€‘
- æœ€ä½{min_characters}æ–‡å­—ä»¥ä¸Šï¼ˆå¤±æ•—ã¨æˆåŠŸã§åˆè¨ˆï¼‰
- ğŸ’€ å¤±æ•—ã‚·ãƒŠãƒªã‚ª: é…ç½®ã®ãƒã‚¬ãƒ†ã‚£ãƒ–ãªå´é¢ãŒå‡ºãŸå ´åˆ
- âœ¨ æˆåŠŸã‚·ãƒŠãƒªã‚ª: é…ç½®ã‚’ãƒã‚¸ãƒ†ã‚£ãƒ–ã«æ´»ã‹ã—ãŸå ´åˆ
- å…·ä½“çš„ãªå ´é¢æå†™ï¼ˆä¼šè­°å®¤ã€ã‚ªãƒ•ã‚£ã‚¹ã€ãƒ—ãƒ¬ã‚¼ãƒ³ãªã©ï¼‰
- ç™»å ´äººç‰©ã®å¿ƒç†æå†™ã‚’å«ã‚ã‚‹
- èª­è€…ãŒæ„Ÿæƒ…ç§»å…¥ã§ãã‚‹ãƒªã‚¢ãƒªãƒ†ã‚£""",
    },
    
    "action": {
        "prefix": "ã€æè¨€ã¨ãƒ¯ãƒ¼ã‚¯ã€‘",
        "instruction": """ã“ã®é…ç½®ã‚’æ´»ã‹ã™ãŸã‚ã®å…·ä½“çš„ãªè¡Œå‹•æŒ‡é‡ã¨ã‚»ãƒ«ãƒ•ãƒ¯ãƒ¼ã‚¯ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

{specific_instruction}

ã€è¡Œå‹•æŒ‡é‡ã®æ ¹æ‹ ã¨ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã€‘
{variables_json}

ã€å‡ºåŠ›è¦ä»¶ã€‘
- æœ€ä½{min_characters}æ–‡å­—ä»¥ä¸Š
- æ˜æ—¥ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ãªå…·ä½“çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- 3ã¤ç¨‹åº¦ã®æè¨€ï¼ˆç®‡æ¡æ›¸ãå¯ï¼‰
- å†…çœã®ãŸã‚ã®ãƒ¯ãƒ¼ã‚¯ï¼ˆè³ªå•å½¢å¼ãªã©ï¼‰
- ç¿’æ…£åŒ–ã®ãŸã‚ã®ãƒ«ãƒ¼ãƒãƒ³ææ¡ˆ""",
    },
    
    "letter": {
        "prefix": "ã€CEOã¸ã®æ‰‹ç´™ã€‘",
        "instruction": """ã“ã®äººã®å¤ªé™½ï¼ˆCEOï¼‰ã«å‘ã‘ãŸã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸæ‰‹ç´™ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚

{specific_instruction}

ã€æ‰‹ç´™ã«ç››ã‚Šè¾¼ã‚€ãƒ‡ãƒ¼ã‚¿ã€‘
{variables_json}

ã€å‡ºåŠ›è¦ä»¶ã€‘
- æœ€ä½{min_characters}æ–‡å­—ä»¥ä¸Š
- å†’é ­: ã€Œè¦ªæ„›ãªã‚‹[å¤ªé™½ã®ã‚µã‚¤ãƒ³]ã®CEOã¸ã€
- æ¸©ã‹ã¿ã®ã‚ã‚‹ã€ã—ã‹ã—çš„ç¢ºãªã‚¢ãƒ‰ãƒã‚¤ã‚¹
- ã“ã‚Œã¾ã§ã®åˆ†æã‚’çµ±åˆã—ãŸç·æ‹¬
- åŠ±ã¾ã—ã¨å…·ä½“çš„ãªæ–¹å‘æ€§ã®æç¤º
- çµã³ã®è¨€è‘‰""",
    },
}


# =============================================================================
# ç« åˆ¥ã®ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤º
# =============================================================================

CHAPTER_SPECIFIC_INSTRUCTIONS = {
    "1-A": {
        "analysis": "ç«{fire_count}ã€åœ°{earth_count}ã€é¢¨{air_count}ã€æ°´{water_count}ã¨ã„ã†åˆ†å¸ƒã‹ã‚‰èª­ã¿å–ã‚Œã‚‹çµŒå–¶ç‰¹æ€§ã‚’è©³ç´°ã«åˆ†æã—ã¦ãã ã•ã„ã€‚å„ªä½ãªå…ƒç´ ï¼ˆ{dominant_element}ï¼‰ã¨ä¸è¶³ã™ã‚‹å…ƒç´ ï¼ˆ{lacking_element}ï¼‰ã®ä¸¡é¢ã‹ã‚‰ã€å…·ä½“çš„ãªãƒ“ã‚¸ãƒã‚¹ã‚·ãƒ¼ãƒ³ã§ã®å‚¾å‘ã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚",
        "scenario": "ã“ã®4å…ƒç´ ãƒãƒ©ãƒ³ã‚¹ã‚’æŒã¤çµŒå–¶è€…ãŒç›´é¢ã—ã†ã‚‹ã€Œå¤±æ•—ã‚·ãƒŠãƒªã‚ªã€ã¨ã€ŒæˆåŠŸã‚·ãƒŠãƒªã‚ªã€ã‚’ã€ãã‚Œãã‚Œå°èª¬å½¢å¼ã§æå†™ã—ã¦ãã ã•ã„ã€‚",
        "action": "ä¸è¶³ã—ã¦ã„ã‚‹å…ƒç´ ï¼ˆ{lacking_element}ï¼‰ã‚’è£œã†ãŸã‚ã®å…·ä½“çš„ãªè¡Œå‹•æŒ‡é‡ã‚’3ã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€å„ªä½ãªå…ƒç´ ï¼ˆ{dominant_element}ï¼‰ã‚’æ´»ã‹ã™ãŸã‚ã®æˆ¦ç•¥ã‚‚æç¤ºã—ã¦ãã ã•ã„ã€‚",
    },
    
    "1-B": {
        "analysis": "3åŒºåˆ†ãƒãƒ©ãƒ³ã‚¹ï¼ˆæ´»å‹•{cardinal_count}ã€å›ºå®š{fixed_count}ã€æŸ”è»Ÿ{mutable_count}ï¼‰ã¨ã‚¢ãƒ³ã‚°ãƒ«ã®ã‚µã‚¤ãƒ³é…ç½®ã‹ã‚‰ã€çµŒå–¶è€…ã¨ã—ã¦ã®è¡Œå‹•ç‰¹æ€§ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚ASC({asc_sign})ãŒç¤ºã™å¸‚å ´å‚å…¥ã‚¹ã‚¿ã‚¤ãƒ«ã€MC({mc_sign})ãŒç¤ºã™åˆ°é”ç›®æ¨™ã‚’å…·ä½“çš„ã«è¿°ã¹ã¦ãã ã•ã„ã€‚",
        "symbol": "ASCã®ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã‚’ç‰©èªçš„ã«è§£é‡ˆã—ã€ã“ã®äººã®ã€Œä¸–ç•Œã¨ã®é–¢ã‚ã‚Šæ–¹ã€ã®æ·±å±¤ã‚’èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚",
        "action": "ã‚¢ãƒ³ã‚°ãƒ«ã®é…ç½®ã‚’æ´»ã‹ã—ãŸå…·ä½“çš„ãªã‚­ãƒ£ãƒªã‚¢æˆ¦ç•¥ã¨è¡Œå‹•æŒ‡é‡ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "2-A": {
        "analysis": "å¤ªé™½({sun_sign}ãƒ»{sun_house}ãƒã‚¦ã‚¹)ã¨æœˆ({moon_sign}ãƒ»{moon_house}ãƒã‚¦ã‚¹)ã®é…ç½®ã‹ã‚‰ã€ã“ã®äººã®çµŒå–¶ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚CEOã®ãƒ“ã‚¸ãƒ§ãƒ³ã¨CFOã®æ„Ÿæƒ…çš„ãƒ‹ãƒ¼ã‚ºã®é–¢ä¿‚æ€§ã€{sun_moon_aspect}ã¨ã„ã†ã‚¢ã‚¹ãƒšã‚¯ãƒˆãŒçµŒå–¶ã«ã‚‚ãŸã‚‰ã™å½±éŸ¿ã‚’è©³è¿°ã—ã¦ãã ã•ã„ã€‚",
        "symbol": "å¤ªé™½ã®ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã€Œ{sun_sabian_symbol}ã€ã¨æœˆã®ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã€Œ{moon_sabian_symbol}ã€ã‚’ç‰©èªçš„ã«è§£é‡ˆã—ã€CEOã®çœŸã®ä½¿å‘½ã¨CFOã®æ·±å±¤ãƒ‹ãƒ¼ã‚ºã‚’èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚",
        "scenario": "ã“ã®äººã®å¤ªé™½ï¼ˆCEOï¼‰ã¨æœˆï¼ˆCFOï¼‰ãŒçµŒå–¶ä¼šè­°ã§å¯¾è©±ã—ã¦ã„ã‚‹æ§˜å­ã‚’ã€å°èª¬å½¢å¼ã§æå†™ã—ã¦ãã ã•ã„ã€‚è‘›è—¤ãŒã‚ã‚‹å ´åˆã¯ãã®å…‹æœéç¨‹ã‚‚å«ã‚ã¦ãã ã•ã„ã€‚",
        "action": "å¤ªé™½ã¨æœˆã‚’çµ±åˆã™ã‚‹ãŸã‚ã®æ—¥å¸¸çš„ãªãƒ«ãƒ¼ãƒãƒ³ã‚„ãƒ¯ãƒ¼ã‚¯ã‚’å…·ä½“çš„ã«ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "2-B": {
        "analysis": "æ°´æ˜Ÿ({mercury_sign}ãƒ»{mercury_house}ãƒã‚¦ã‚¹)ã€é‡‘æ˜Ÿ({venus_sign}ãƒ»{venus_house}ãƒã‚¦ã‚¹)ã€ç«æ˜Ÿ({mars_sign}ãƒ»{mars_house}ãƒã‚¦ã‚¹)ã®é…ç½®ã‹ã‚‰ã€ã“ã®äººã®ä»•äº‹ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚é€†è¡ŒãŒã‚ã‚‹å ´åˆã¯ãã®å½±éŸ¿ã‚‚å«ã‚ã¦ãã ã•ã„ã€‚",
        "symbol": "æ°´æ˜Ÿã€Œ{mercury_sabian_symbol}ã€ã€é‡‘æ˜Ÿã€Œ{venus_sabian_symbol}ã€ã€ç«æ˜Ÿã€Œ{mars_sabian_symbol}ã€ã®ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã‚’çµ±åˆçš„ã«è§£é‡ˆã—ã€ã“ã®äººã®å®Ÿå‹™ã«ãŠã‘ã‚‹æ·±å±¤ãƒ†ãƒ¼ãƒã‚’èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚",
        "scenario": "ã“ã®äººãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ¼ãƒ€ãƒ¼ã¨ã—ã¦æ´»å‹•ã™ã‚‹æ§˜å­ã‚’ã€æ°´æ˜Ÿãƒ»é‡‘æ˜Ÿãƒ»ç«æ˜Ÿã®ç‰¹æ€§ã‚’æ´»ã‹ã—ãŸæˆåŠŸã‚·ãƒŠãƒªã‚ªã¨ã—ã¦æå†™ã—ã¦ãã ã•ã„ã€‚",
        "action": "æ°´æ˜Ÿãƒ»é‡‘æ˜Ÿãƒ»ç«æ˜Ÿã‚’æœ€å¤§é™ã«æ´»ã‹ã™ãŸã‚ã®å…·ä½“çš„ãªè¡Œå‹•æŒ‡é‡ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "3-A": {
        "analysis": "æœ¨æ˜Ÿ({jupiter_sign}ãƒ»{jupiter_house}ãƒã‚¦ã‚¹)ã¨åœŸæ˜Ÿ({saturn_sign}ãƒ»{saturn_house}ãƒã‚¦ã‚¹)ã®é…ç½®ã‹ã‚‰ã€ã“ã®äººã®ç¤¾ä¼šçš„æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã¨èª²é¡Œã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚æœ¨æ˜ŸåœŸæ˜Ÿé–“ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆ({jupiter_saturn_aspect})ã®å½±éŸ¿ã‚‚å«ã‚ã¦ãã ã•ã„ã€‚",
        "symbol": "æœ¨æ˜Ÿã€Œ{jupiter_sabian_symbol}ã€ã¨åœŸæ˜Ÿã€Œ{saturn_sabian_symbol}ã€ã®ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã‹ã‚‰ã€ç¤¾ä¼šçš„ä½¿å‘½ã¨ä¹—ã‚Šè¶Šãˆã‚‹ã¹ãå£ã‚’èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚",
        "scenario": "ã“ã®äººãŒç¤¾ä¼šçš„ãªæˆåŠŸã‚’åã‚ã‚‹éç¨‹ã‚’ã€æœ¨æ˜Ÿã®æ‹¡å¤§ã¨åœŸæ˜Ÿã®è©¦ç·´ã‚’ç¹”ã‚Šäº¤ãœãŸç‰©èªã¨ã—ã¦æå†™ã—ã¦ãã ã•ã„ã€‚",
        "action": "æœ¨æ˜Ÿã®æ©æµã‚’å—ã‘å–ã‚Šã€åœŸæ˜Ÿã®èª²é¡Œã‚’ä¹—ã‚Šè¶Šãˆã‚‹ãŸã‚ã®å…·ä½“çš„ãªè¡Œå‹•æŒ‡é‡ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "3-B": {
        "analysis": "å¤©ç‹æ˜Ÿ({uranus_sign}ãƒ»{uranus_house}ãƒã‚¦ã‚¹)ã€æµ·ç‹æ˜Ÿ({neptune_sign}ãƒ»{neptune_house}ãƒã‚¦ã‚¹)ã€å†¥ç‹æ˜Ÿ({pluto_sign}ãƒ»{pluto_house}ãƒã‚¦ã‚¹)ã®é…ç½®ã‹ã‚‰ã€ã“ã®äººãŒæ‹…ã†ä¸–ä»£çš„ãƒ†ãƒ¼ãƒã¨å€‹äººçš„ãªå¤‰é©ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚å€‹äººå¤©ä½“ã¨ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆãŒã‚ã‚‹å ´åˆã¯ç‰¹ã«è©³ã—ãè¿°ã¹ã¦ãã ã•ã„ã€‚",
        "symbol": "ãƒˆãƒ©ãƒ³ã‚¹ã‚µã‚¿ãƒ‹ã‚¢ãƒ³ã®ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã‹ã‚‰ã€ã“ã®äººãŒé–¢ã‚ã‚‹é›†åˆçš„ãƒ»æ™‚ä»£çš„ãƒ†ãƒ¼ãƒã‚’èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚",
        "scenario": "ã“ã®äººãŒãƒˆãƒ©ãƒ³ã‚¹ã‚µã‚¿ãƒ‹ã‚¢ãƒ³ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’å»ºè¨­çš„ã«æ´»ã‹ã—ã€å¤‰é©ã‚’æˆã—é‚ã’ã‚‹ç‰©èªã‚’æå†™ã—ã¦ãã ã•ã„ã€‚",
        "action": "ãƒˆãƒ©ãƒ³ã‚¹ã‚µã‚¿ãƒ‹ã‚¢ãƒ³ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’å‘³æ–¹ã«ã¤ã‘ã‚‹ãŸã‚ã®å¿ƒæ§‹ãˆã¨è¡Œå‹•æŒ‡é‡ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "4-A": {
        "analysis": "ä¸»è¦ãªã‚¢ã‚¹ãƒšã‚¯ãƒˆé…ç½®ã‹ã‚‰ã€ã“ã®äººã®å†…çš„ãªåŠ›å­¦ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚ç‰¹ã«å¼·ã„ã‚¢ã‚¹ãƒšã‚¯ãƒˆï¼ˆ{strongest_aspect}ï¼‰ã¨æŒ‘æˆ¦çš„ãªã‚¢ã‚¹ãƒšã‚¯ãƒˆï¼ˆ{challenging_aspects}ï¼‰ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãã ã•ã„ã€‚ã‚¢ã‚¹ãƒšã‚¯ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚‹å ´åˆã¯ã€ãã®çµ±åˆçš„ãªæ„å‘³ã‚’è©³è¿°ã—ã¦ãã ã•ã„ã€‚",
        "symbol": "æœ€ã‚‚æŒ‘æˆ¦çš„ãªã‚¢ã‚¹ãƒšã‚¯ãƒˆãŒç¤ºã™æ·±å±¤çš„ãªäººç”Ÿãƒ†ãƒ¼ãƒã‚’ã€è±¡å¾´çš„ã«èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚",
        "scenario": "ã“ã®äººãŒä¸»è¦ãªã‚¢ã‚¹ãƒšã‚¯ãƒˆã®è‘›è—¤ã‚’çµŒé¨“ã—ã€ã‚„ãŒã¦çµ±åˆã«è‡³ã‚‹ç‰©èªã‚’æå†™ã—ã¦ãã ã•ã„ã€‚ğŸ’€å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨âœ¨æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¸¡æ–¹ã‚’å«ã‚ã¦ãã ã•ã„ã€‚",
        "action": "ã‚¢ã‚¹ãƒšã‚¯ãƒˆã®ç·Šå¼µã‚’å»ºè¨­çš„ã«æ´»ã‹ã™ãŸã‚ã®å…·ä½“çš„ãªè¡Œå‹•æŒ‡é‡ã¨ãƒ¯ãƒ¼ã‚¯ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "4-B": {
        "analysis": "ã‚«ã‚¤ãƒ­ãƒ³({chiron_sign}ãƒ»{chiron_house}ãƒã‚¦ã‚¹)ã®é…ç½®ã‹ã‚‰ã€ã“ã®äººãŒæŠ±ãˆã‚‹å‚·ã®ãƒ†ãƒ¼ãƒã¨ã€ãã‚Œã‚’ç™’ã—ã®åŠ›ã«å¤‰æ›ã™ã‚‹å¯èƒ½æ€§ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚ä»–ã®å¤©ä½“ã¨ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆãŒã‚ã‚‹å ´åˆã¯ãã®å½±éŸ¿ã‚‚å«ã‚ã¦ãã ã•ã„ã€‚",
        "symbol": "ã‚«ã‚¤ãƒ­ãƒ³ã®ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã€Œ{chiron_sabian_symbol}ã€ã‹ã‚‰ã€å‚·ã®æ·±å±¤çš„ãªæ„å‘³ã¨ç™’ã—ã¸ã®é“ç­‹ã‚’èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚",
        "scenario": "ã“ã®äººãŒã‚«ã‚¤ãƒ­ãƒ³ã®å‚·ã¨å‘ãåˆã„ã€ã‚„ãŒã¦ãã‚Œã‚’ä»–è€…ã‚’åŠ©ã‘ã‚‹åŠ›ã«å¤‰ãˆã¦ã„ãç‰©èªã‚’æå†™ã—ã¦ãã ã•ã„ã€‚",
        "action": "ã‚«ã‚¤ãƒ­ãƒ³ã®å‚·ã‚’ã€Œãƒ‹ãƒƒãƒæˆ¦ç•¥ã€ã¨ã—ã¦æ´»ã‹ã™ãŸã‚ã®å…·ä½“çš„ãªæ–¹å‘æ€§ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "4-C": {
        "analysis": "ãƒ‰ãƒ©ã‚´ãƒ³ãƒ˜ãƒƒãƒ‰({north_node_sign}ãƒ»{north_node_house}ãƒã‚¦ã‚¹)ã¨ãƒ‰ãƒ©ã‚´ãƒ³ãƒ†ã‚¤ãƒ«({south_node_sign}ãƒ»{south_node_house}ãƒã‚¦ã‚¹)ã®é…ç½®ã‹ã‚‰ã€ã“ã®äººã®äººç”Ÿã®æˆé•·è»¸ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚ãƒ†ã‚¤ãƒ«ã®æ‰èƒ½ã‚’ã©ã®ã‚ˆã†ã«ãƒ˜ãƒƒãƒ‰ã®æ–¹å‘ã«æ´»ã‹ã™ã¹ãã‹ã‚’å…·ä½“çš„ã«è¿°ã¹ã¦ãã ã•ã„ã€‚",
        "symbol": "ãƒ‰ãƒ©ã‚´ãƒ³ãƒ˜ãƒƒãƒ‰ã®ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã€Œ{north_node_sabian_symbol}ã€ã‹ã‚‰ã€ã“ã®äººã®ä½¿å‘½ã®æ·±å±¤çš„ãªæ„å‘³ã‚’èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚",
        "scenario": "ã“ã®äººãŒãƒ‰ãƒ©ã‚´ãƒ³ãƒ†ã‚¤ãƒ«ã®å®‰ä½åœ°å¸¯ã‹ã‚‰è¸ã¿å‡ºã—ã€ãƒ‰ãƒ©ã‚´ãƒ³ãƒ˜ãƒƒãƒ‰ã®æ–¹å‘ã«æˆé•·ã—ã¦ã„ãç‰©èªã‚’æå†™ã—ã¦ãã ã•ã„ã€‚",
        "action": "ãƒ‰ãƒ©ã‚´ãƒ³ãƒ˜ãƒƒãƒ‰ã®æ–¹å‘ã«æ—¥å¸¸çš„ã«æˆé•·ã™ã‚‹ãŸã‚ã®å…·ä½“çš„ãªè¡Œå‹•æŒ‡é‡ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "5-A": {
        "analysis": "2ãƒã‚¦ã‚¹({second_house_cusp_sign})ã®é…ç½®ã¨å†…éƒ¨ã®å¤©ä½“ã€ãƒ«ãƒ¼ãƒ©ãƒ¼ã®ä½ç½®ã‹ã‚‰ã€ã“ã®äººã®åå…¥ç²å¾—ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨çµŒæ¸ˆçš„ä¾¡å€¤è¦³ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚",
        "symbol": "2ãƒã‚¦ã‚¹ã‚«ã‚¹ãƒ—ã®ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã‹ã‚‰ã€åå…¥ã¨è‡ªå·±ä¾¡å€¤ã«é–¢ã™ã‚‹æ·±å±¤ãƒ†ãƒ¼ãƒã‚’èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚",
        "scenario": "ã“ã®äººãŒ2ãƒã‚¦ã‚¹ã®ç‰¹æ€§ã‚’æ´»ã‹ã—ã¦çµŒæ¸ˆçš„æˆåŠŸã‚’åã‚ã‚‹ç‰©èªã‚’æå†™ã—ã¦ãã ã•ã„ã€‚",
        "action": "2ãƒã‚¦ã‚¹ã®é…ç½®ã‚’æ´»ã‹ã—ãŸå…·ä½“çš„ãªåå…¥æˆ¦ç•¥ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "5-B": {
        "analysis": "6ãƒã‚¦ã‚¹({sixth_house_cusp_sign})ã®é…ç½®ã‹ã‚‰ã€ã“ã®äººã®åƒãæ–¹ã¨è·å ´ç’°å¢ƒã¸ã®é©å¿œãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚å¥åº·ç®¡ç†ã¨ã®é–¢é€£ã‚‚å«ã‚ã¦ãã ã•ã„ã€‚",
        "symbol": "6ãƒã‚¦ã‚¹ã‚«ã‚¹ãƒ—ã®ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã‹ã‚‰ã€åŠ´åƒã¨å¥‰ä»•ã«é–¢ã™ã‚‹æ·±å±¤ãƒ†ãƒ¼ãƒã‚’èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚",
        "scenario": "ã“ã®äººãŒ6ãƒã‚¦ã‚¹ã®ç‰¹æ€§ã‚’æ´»ã‹ã—ã¦å……å®Ÿã—ãŸè·æ¥­ç”Ÿæ´»ã‚’é€ã‚‹æ§˜å­ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚",
        "action": "6ãƒã‚¦ã‚¹ã®é…ç½®ã‚’æ´»ã‹ã—ãŸå…·ä½“çš„ãªåƒãæ–¹ã®æ”¹å–„ç­–ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "5-C": {
        "analysis": "MC({mc_sign})ã¨10ãƒã‚¦ã‚¹ã®é…ç½®ã‹ã‚‰ã€ã“ã®äººã®å¤©è·ã®æ–¹å‘æ€§ã¨ç¤¾ä¼šçš„é”æˆã®å½¢ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚MCãƒ«ãƒ¼ãƒ©ãƒ¼ã®ä½ç½®ã¨ã‚¢ã‚¹ãƒšã‚¯ãƒˆã‚‚è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚",
        "symbol": "MCã®ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã€Œ{mc_sabian_symbol}ã€ã‹ã‚‰ã€ã“ã®äººã®ç¤¾ä¼šçš„ä½¿å‘½ã®æ·±å±¤çš„ãªæ„å‘³ã‚’èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚",
        "scenario": "ã“ã®äººãŒMCã®æ–¹å‘æ€§ã«æ²¿ã£ã¦ã‚­ãƒ£ãƒªã‚¢ã‚’ç¯‰ãã€ç¤¾ä¼šçš„æˆåŠŸã‚’åã‚ã‚‹ç‰©èªã‚’æå†™ã—ã¦ãã ã•ã„ã€‚",
        "action": "10ãƒã‚¦ã‚¹ã®é…ç½®ã‚’æ´»ã‹ã—ãŸå…·ä½“çš„ãªã‚­ãƒ£ãƒªã‚¢æˆ¦ç•¥ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "6-A": {
        "analysis": "P-å¤ªé™½({progressed_sun_sign}ãƒ»{progressed_sun_house}ãƒã‚¦ã‚¹)ã¨P-æœˆ({progressed_moon_sign}ãƒ»{progressed_moon_house}ãƒã‚¦ã‚¹)ã®ç¾åœ¨ä½ç½®ã‹ã‚‰ã€ã“ã®äººã®å†…çš„æˆç†Ÿæ®µéšã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚",
        "symbol": "ç¾åœ¨ã®P-å¤ªé™½ã®åº¦æ•°ã«å¯¾å¿œã™ã‚‹ã‚µãƒ“ã‚¢ãƒ³ã‚·ãƒ³ãƒœãƒ«ã‹ã‚‰ã€ä»Šã®ãƒ†ãƒ¼ãƒã‚’èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚",
        "scenario": "ã“ã®äººã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãŒç¤ºã™ä»Šå¾Œ3å¹´é–“ã®å†…çš„å¤‰åŒ–ã‚’ã€ç‰©èªå½¢å¼ã§æå†™ã—ã¦ãã ã•ã„ã€‚{upcoming_progressed_events}ã®å½±éŸ¿ã‚’å«ã‚ã¦ãã ã•ã„ã€‚",
        "action": "ç¾åœ¨ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹é…ç½®ã‚’æ´»ã‹ã™ãŸã‚ã®å¿ƒæ§‹ãˆã¨å…·ä½“çš„ãªè¡Œå‹•ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "6-B": {
        "analysis": "ä»Šå¾Œ3å¹´é–“ã®ä¸»è¦ãªãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¦‚è¦³ã—ã€ãã‚Œãã‚Œã®å¹´ã®åŸºèª¿ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚æä¾›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€å…·ä½“çš„ãªæ™‚æœŸã¨å½±éŸ¿ã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚",
        "scenario_year1": "{transit_year1_events}ã«åŸºã¥ãã€1å¹´ç›®ã«äºˆæƒ³ã•ã‚Œã‚‹å±•é–‹ã‚’ç‰©èªå½¢å¼ã§æå†™ã—ã¦ãã ã•ã„ã€‚å…·ä½“çš„ãªæ™‚æœŸï¼ˆæœˆï¼‰ã‚’å«ã‚ã¦ãã ã•ã„ã€‚",
        "scenario_year2": "{transit_year2_events}ã«åŸºã¥ãã€2å¹´ç›®ã«äºˆæƒ³ã•ã‚Œã‚‹å±•é–‹ã‚’ç‰©èªå½¢å¼ã§æå†™ã—ã¦ãã ã•ã„ã€‚",
        "scenario_year3": "{transit_year3_events}ã«åŸºã¥ãã€3å¹´ç›®ã«äºˆæƒ³ã•ã‚Œã‚‹å±•é–‹ã‚’ç‰©èªå½¢å¼ã§æå†™ã—ã¦ãã ã•ã„ã€‚",
        "action": "ä»Šå¾Œ3å¹´é–“ã‚’è¦‹æ®ãˆãŸæˆ¦ç•¥çš„ãªè¡Œå‹•è¨ˆç”»ã‚’ã€å¹´åº¦åˆ¥ã«ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
    
    "6-C": {
        "letter": "ã“ã®äººã®å¤ªé™½ï¼ˆCEOï¼‰ã«å‘ã‘ãŸã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸæ‰‹ç´™ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚ã“ã‚Œã¾ã§ã®åˆ†æã§æ˜ã‚‰ã‹ã«ãªã£ãŸå¼·ã¿ã€èª²é¡Œã€ãã—ã¦ä»Šå¾Œã®æ–¹å‘æ€§ã‚’çµ±åˆã—ã€æ¸©ã‹ãã‚‚çš„ç¢ºãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å«ã‚ã¦ãã ã•ã„ã€‚æ‰‹ç´™å½¢å¼ã§ã€å†’é ­ã¯ã€Œè¦ªæ„›ãªã‚‹{sun_sign}ã®CEOã¸ã€ã§å§‹ã‚ã¦ãã ã•ã„ã€‚",
        "action": "ã“ã®é‘‘å®šæ›¸ã‚’èª­ã¿çµ‚ãˆãŸä»Šæ—¥ã‹ã‚‰å§‹ã‚ã‚‰ã‚Œã‚‹ã€å…·ä½“çš„ãª3ã¤ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
    },
}


# =============================================================================
# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆé–¢æ•°
# =============================================================================

class PromptGenerator:
    """ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã‚¯ãƒ©ã‚¹"""
    
    def __init__(self, master_content: Dict[str, Any]):
        """
        åˆæœŸåŒ–
        
        Args:
            master_content: ãƒã‚¹ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„JSON
        """
        self.master_content = master_content
        self.system_settings = master_content.get("system_settings", {})
        self.writing_method = self.system_settings.get("writing_method", {})
    
    def get_system_prompt(self) -> str:
        """ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—"""
        return SYSTEM_PROMPT_BASE + SYSTEM_PROMPT_CHARACTER_COUNT
    
    def get_step_prompts(
        self, 
        step_id: str, 
        variables: Dict[str, Any],
        user_profile: Optional[str] = None,
        previous_summary: Optional[str] = None
    ) -> Dict[str, str]:
        """
        ç‰¹å®šã‚¹ãƒ†ãƒƒãƒ—ã®å…¨ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
        
        Args:
            step_id: ã‚¹ãƒ†ãƒƒãƒ—ID
            variables: å¤‰æ•°è¾æ›¸
            user_profile: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆStep 2ä»¥é™ï¼‰
            previous_summary: å‰ç« ã®è¦ç´„
        
        Returns:
            ãƒ–ãƒ­ãƒƒã‚¯åã‚’ã‚­ãƒ¼ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å€¤ã¨ã™ã‚‹è¾æ›¸
        """
        prompts = {}
        
        # ç« å›ºæœ‰ã®æŒ‡ç¤ºã‚’å–å¾—
        chapter_instructions = CHAPTER_SPECIFIC_INSTRUCTIONS.get(step_id, {})
        
        # ãƒ–ãƒ­ãƒƒã‚¯å®šç¾©ã‚’å–å¾—
        blocks = self.writing_method.get("blocks", [])
        
        for block in blocks:
            block_id = block.get("id")
            if block.get("type") == "static":
                continue  # é™çš„ãƒ–ãƒ­ãƒƒã‚¯ã¯ã‚¹ã‚­ãƒƒãƒ—
            
            if block_id not in chapter_instructions:
                continue
            
            # ãƒ–ãƒ­ãƒƒã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
            template = BLOCK_TEMPLATES.get(block_id, {})
            if not template:
                continue
            
            # å¤‰æ•°ã‚’æ–‡å­—åˆ—ã«å±•é–‹
            specific_instruction = chapter_instructions.get(block_id, "")
            try:
                specific_instruction = specific_instruction.format(**variables)
            except KeyError as e:
                specific_instruction = f"[å¤‰æ•° {e} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“] " + specific_instruction
            
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
            prompt = template.get("instruction", "").format(
                specific_instruction=specific_instruction,
                variables_json=json.dumps(variables, ensure_ascii=False, indent=2),
                min_characters=block.get("min_characters", 500)
            )
            
            # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’è¿½åŠ 
            context = ""
            if user_profile:
                context += f"\n\nã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã“ã®äººã®åŸºæœ¬çš„ç‰¹æ€§ï¼‰ã€‘\n{user_profile}"
            if previous_summary:
                context += f"\n\nã€å‰ç« ã®è¦ç´„ã€‘\n{previous_summary}"
            
            full_prompt = prompt + context
            
            prompts[block_id] = {
                "prefix": template.get("prefix", ""),
                "prompt": full_prompt,
                "min_characters": block.get("min_characters", 500),
            }
        
        return prompts
    
    def generate_user_profile_prompt(self, variables: Dict[str, Any]) -> str:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
        
        Args:
            variables: Step 1-A, 1-B, 2-Aã®å¤‰æ•°ã‚’çµ±åˆã—ãŸã‚‚ã®
        
        Returns:
            ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—
        """
        return f"""ä»¥ä¸‹ã®å æ˜Ÿè¡“ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã€ã“ã®äººã®ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚’500æ–‡å­—ä»¥å†…ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€ãƒ‡ãƒ¼ã‚¿ã€‘
{json.dumps(variables, ensure_ascii=False, indent=2)}

ã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«å«ã‚ã‚‹å†…å®¹ã€‘
1. åŸºæœ¬çš„ãªæ€§æ ¼ç‰¹æ€§ï¼ˆ4å…ƒç´ ãƒ»3åŒºåˆ†ã‹ã‚‰ï¼‰
2. æ ¸ã¨ãªã‚‹å‹•æ©Ÿã¨æ¬²æ±‚ï¼ˆå¤ªé™½ãƒ»æœˆã‹ã‚‰ï¼‰
3. ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ°´æ˜Ÿãƒ»é‡‘æ˜Ÿã‹ã‚‰ï¼‰
4. è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç«æ˜Ÿã‹ã‚‰ï¼‰
5. æˆé•·ã®æ–¹å‘æ€§ï¼ˆãƒ‰ãƒ©ã‚´ãƒ³ãƒ˜ãƒƒãƒ‰ã‹ã‚‰ï¼‰

ã€å‡ºåŠ›å½¢å¼ã€‘
- ç®‡æ¡æ›¸ãã§ã¯ãªãã€æµã‚Œã‚‹ã‚ˆã†ãªæ–‡ç« ã§
- 500æ–‡å­—ä»¥å†…ã«åã‚ã‚‹
- ã“ã®äººã‚’ç¬¬ä¸‰è€…ã«ç´¹ä»‹ã™ã‚‹ã‚ˆã†ãªå®¢è¦³çš„ãªãƒˆãƒ¼ãƒ³ã§
- ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ã‚½ãƒ³ã¨ã—ã¦ã®ç‰¹æ€§ã‚’å¼·èª¿"""
    
    def generate_bridging_sentence(
        self, 
        current_step: str, 
        next_step: str,
        current_topic: str,
        next_topic: str
    ) -> str:
        """
        ç« é–“ã®æ©‹æ¸¡ã—æ–‡ã‚’ç”Ÿæˆ
        
        Args:
            current_step: ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ID
            next_step: æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ID
            current_topic: ç¾åœ¨ã®ç« ã®ãƒˆãƒ”ãƒƒã‚¯
            next_topic: æ¬¡ã®ç« ã®ãƒˆãƒ”ãƒƒã‚¯
        
        Returns:
            æ©‹æ¸¡ã—æ–‡
        """
        bridging_config = self.master_content.get("bridging_sentences", {})
        transitions = bridging_config.get("chapter_transitions", {})
        
        key = f"{current_step}_to_{next_step}"
        if key in transitions:
            return transitions[key].get("closing", "")
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ©‹æ¸¡ã—æ–‡
        template = bridging_config.get("closing_template", "")
        return template.format(
            current_topic=current_topic,
            next_topic=next_topic
        )
    
    def generate_recovery_prompt(self, block_content: str, target_characters: int) -> str:
        """
        æ–‡å­—æ•°ä¸è¶³æ™‚ã®ãƒªã‚«ãƒãƒªãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
        
        Args:
            block_content: ç¾åœ¨ã®ç”Ÿæˆå†…å®¹
            target_characters: ç›®æ¨™æ–‡å­—æ•°
        
        Returns:
            ãƒªã‚«ãƒãƒªãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        """
        current_count = len(block_content)
        shortage = target_characters - current_count
        
        return f"""ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã«ã€{shortage}æ–‡å­—ç¨‹åº¦ã®è¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä»˜ã‘åŠ ãˆã¦ãã ã•ã„ã€‚

ã€ç¾åœ¨ã®ãƒ†ã‚­ã‚¹ãƒˆã€‘
{block_content}

ã€è¿½åŠ ã®æŒ‡ç¤ºã€‘
- åŒã˜å†…å®¹ã‚’ç¹°ã‚Šè¿”ã•ãªã„ã§ãã ã•ã„
- æ–°ã—ã„è¦–ç‚¹ã€å…·ä½“ä¾‹ã€ã¾ãŸã¯è©³ç´°ãªåˆ†æã‚’è¿½åŠ ã—ã¦ãã ã•ã„
- è‡ªç„¶ãªæµã‚Œã§æ¥ç¶šã—ã¦ãã ã•ã„
- è¿½åŠ éƒ¨åˆ†ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„"""
    
    def generate_summary_prompt(self, chapter_content: str) -> str:
        """
        ç« ã®è¦ç´„ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        
        Args:
            chapter_content: ç« ã®å…¨å†…å®¹
        
        Returns:
            è¦ç´„ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        """
        return f"""ä»¥ä¸‹ã®ç« ã®å†…å®¹ã‚’300æ–‡å­—ä»¥å†…ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚
æ¬¡ã®ç« ã¸ã®æ–‡è„ˆã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ãŸã‚ã€é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

ã€ç« ã®å†…å®¹ã€‘
{chapter_content}

ã€è¦ç´„ã®è¦ä»¶ã€‘
- 300æ–‡å­—ä»¥å†…
- ä¸»è¦ãªåˆ†æçµæœã¨æ´å¯Ÿã‚’å«ã‚ã‚‹
- æ¬¡ã®ç« ã¸ã®ä¼ç·šã¨ãªã‚‹è¦ç´ ã‚’å¼·èª¿
- ç®‡æ¡æ›¸ãã§ã¯ãªãæ–‡ç« å½¢å¼ã§"""


# =============================================================================
# ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨é–¢æ•°
# =============================================================================

def create_prompt_generator(master_content_path: str = "anti_gravity_master_content.json") -> PromptGenerator:
    """
    ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½œæˆ
    
    Args:
        master_content_path: ãƒã‚¹ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„JSONã®ãƒ‘ã‚¹
    
    Returns:
        PromptGeneratorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    """
    with open(master_content_path, 'r', encoding='utf-8') as f:
        master_content = json.load(f)
    return PromptGenerator(master_content)


# =============================================================================
# ãƒ†ã‚¹ãƒˆç”¨
# =============================================================================

if __name__ == "__main__":
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    generator = create_prompt_generator()
    
    # ãƒ†ã‚¹ãƒˆå¤‰æ•°
    test_variables = {
        "fire_count": 3,
        "earth_count": 2,
        "air_count": 4,
        "water_count": 1,
        "dominant_element": "air",
        "lacking_element": "water",
    }
    
    prompts = generator.get_step_prompts("1-A", test_variables)
    
    print("=== ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ===")
    print(generator.get_system_prompt()[:500] + "...")
    print("\n=== Step 1-A ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ===")
    for block_id, prompt_data in prompts.items():
        print(f"\n--- {prompt_data['prefix']} ---")
        print(prompt_data['prompt'][:300] + "...")
