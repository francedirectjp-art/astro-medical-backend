# アンチグラビティ プロジェクト
## 制作上の問題点と改善すべき点

---

## 📋 制作上の問題点（Issues）

### 🔴 カテゴリA: 技術的課題（High Priority）

#### 1. Swiss Ephemeris の実装複雑性
| 問題点 | 影響度 | 詳細 |
|--------|--------|------|
| C言語ベースのライブラリ | 高 | サーバーレス環境（Vercel, AWS Lambda等）での導入が困難 |
| 天文暦データファイルの管理 | 中 | 数百MBのデータファイルをサーバーに配置必要 |
| タイムゾーン/サマータイム処理 | 高 | 出生地ごとの正確な時差計算が必須 |

**ダイアログでの言及:**
> "スイスエフェメリスを使わないと度数がずれる"
> "前回アプリ作った時にサビアンシンボルで問題が起きた"

#### 2. コンテキスト長の肥大化
| 問題点 | 影響度 | 詳細 |
|--------|--------|------|
| 全15ステップの文脈を維持 | 高 | 後半セッションで前半の設定を「忘れる」リスク |
| トークンコストの増大 | 中 | 1セッションあたりの入力トークンが膨大に |
| 矛盾の発生 | 高 | 第1章の「強み」と第10章の記述が矛盾する可能性 |

**ダイアログでの言及:**
> "一気にこれを計算させると意味段落が繋がっていかない"
> "考える時間を一気にやらせないで、3000字くらいにして完璧な文章を作る"

#### 3. 生成時間とユーザー体験
| 問題点 | 影響度 | 詳細 |
|--------|--------|------|
| 長時間の待機 | 高 | 3,000文字×15ステップ = 数十分〜1時間以上 |
| ブラウザタイムアウト | 中 | 長時間接続での切断リスク |
| ユーザー離脱 | 高 | 「フリーズした？」と勘違いして離脱 |

#### 4. 文字数の不安定性
| 問題点 | 影響度 | 詳細 |
|--------|--------|------|
| AIの出力文字数が一定しない | 高 | 目標3,000文字に対し1,500文字しか出ないケース |
| 品質のばらつき | 中 | 長文になるほど内容が薄くなる傾向 |
| 合計5万文字の保証 | 高 | クライアントへの約束が果たせない |

**ダイアログでの言及:**
> "3000文字未満なら自動的に再出力（追記）する"

#### 5. PDF生成の品質
| 問題点 | 影響度 | 詳細 |
|--------|--------|------|
| 日本語フォントの崩れ | 高 | 文字化けや豆腐文字の発生 |
| レイアウト崩れ | 中 | 改ページ位置が不自然 |
| フロントエンド処理の限界 | 高 | 5万文字をブラウザで処理は負荷大 |

**ダイアログでの言及:**
> "最終的にPDFにするボタンをアプリの最後のボタンで作る"

---

### 🟡 カテゴリB: 設計・仕様課題（Medium Priority）

#### 6. 未来予測の精度問題
| 問題点 | 影響度 | 詳細 |
|--------|--------|------|
| プログレス計算の複雑さ | 中 | P-太陽、P-月の正確な位置計算 |
| トランジット解釈のAI依存 | 中 | 日付をAIに計算させると間違える |
| 責任範囲の曖昧さ | 低 | 「予測が外れた」場合のクレームリスク |

**ダイアログでの言及:**
> "未来予見ということを考えたときに、正確にある程度スイス・デフィネルスで予想ができた。そしたらそれをベースにして未来予想って大体のAIでできるんだろうか"

#### 7. ソーラーリターンの除外決定
| 問題点 | 影響度 | 詳細 |
|--------|--------|------|
| 機能スコープの制限 | 低 | 年間予測機能がなくなる |
| 計算複雑性の回避 | プラス | 実装リスクの低減 |

**ダイアログでの言及:**
> "ソーラーリターンは不要だと思いました。ここは省いていきましょう"

#### 8. テンプレートと動的生成の境界
| 問題点 | 影響度 | 詳細 |
|--------|--------|------|
| どこまでを固定するか | 中 | 判断基準が曖昧 |
| 固定テキストの執筆負荷 | 中 | 人間が書く部分のボリューム |
| 更新・メンテナンス | 低 | 固定部分の修正時の手間 |

---

### 🟢 カテゴリC: UX/UI課題（Lower Priority）

#### 9. 入力フォームの設計
| 問題点 | 影響度 | 詳細 |
|--------|--------|------|
| 出生地の特定 | 中 | 緯度経度をユーザーが確認できない |
| 出生時間不明の処理 | 中 | デフォルト値（12:00等）の設定 |
| タイムゾーン選択 | 低 | サマータイムの自動判定 |

#### 10. 進捗表示のUX
| 問題点 | 影響度 | 詳細 |
|--------|--------|------|
| 待ち時間の体感 | 中 | 長時間待たされるストレス |
| 中断・再開機能 | 中 | ブラウザを閉じた場合の復帰 |

---

## 💡 改善すべき点（Improvements）

### 🔥 優先度：最高（Must Have）

#### 1. 階層型メモリ設計の導入

**現状の問題:** 全文脈を毎回渡すとトークン爆発
**改善案:**
```
【常に渡す情報】最小限
- ホロスコープデータ（JSON）
- 現在のステップ番号

【その章だけ渡す情報】
- 直前1ステップの要約（300文字）
- その章で扱う天体・ハウス情報のみ

【人物プロファイル】
- Step 2終了時に生成し、以降固定
```

**効果:** トークンコスト削減、一貫性維持

#### 2. 3段階リカバリーシステム

**現状の問題:** 文字数が足りない/多すぎる
**改善案:**
```python
def generate_section(prompt):
    result = llm.generate(prompt)
    char_count = len(result)
    
    if char_count < 2500:
        # 不足時：方向性を指定して追加
        result += llm.generate("（異なる視点で）具体例を追加")
    elif char_count > 4000:
        # 過剰時：要約
        result = llm.generate(f"3000文字に要約：{result}")
    
    return result
```

**効果:** ユーザーに見せる前に品質担保

#### 3. バックエンドPDF生成

**現状の問題:** フロントエンドでの5万文字PDF生成は不安定
**改善案:**
- Python: ReportLab
- Node.js: Puppeteer
- サーバーサイドで生成、URLをユーザーに返す

**効果:** フォント崩れ防止、安定した出力

#### 4. Swiss Ephemeris のPythonラッパー活用

**現状の問題:** C言語ライブラリの導入困難
**改善案:**
- PySwissEph を使用
- 天文暦データファイルをS3等に配置
- サーバーレスではなくコンテナ（Docker）を使用

**効果:** 精密計算の実現

---

### ⭐ 優先度：高（Should Have）

#### 5. ストリーミング表示

**現状の問題:** 生成完了まで何も表示されない
**改善案:**
- OpenAI/Gemini APIのストリーミングモードを使用
- タイプライター効果でリアルタイム表示

**効果:** 体感待ち時間の大幅短縮

#### 6. 橋渡し文の自動挿入

**現状の問題:** 各章の接続が不自然
**改善案:**
- 冒頭: 「前章では○○を見ました。本章では△△に進みます」
- 末尾: 「次章への伏線」を1文追加

**効果:** 読み物としての完成度向上

#### 7. 中断・再開機能

**現状の問題:** ブラウザを閉じると最初から
**改善案:**
- 各ステップ完了時にDB保存
- ユーザーID（またはLocalStorage）で紐づけ
- 「続きから」ボタンで復帰

**効果:** 長時間セッションでも安心

#### 8. 地図連携による出生地確認

**現状の問題:** 緯度経度を確認できない
**改善案:**
- Google Maps API等と連携
- 都市名入力 → 地図にピン表示
- ユーザーが視覚的に確認

**効果:** 計算精度の向上

---

### 📌 優先度：中（Could Have）

#### 9. 自動進行オプション

**改善案:**
- 「自動で最後まで生成」ボタン
- バックグラウンド処理
- 完成通知（メール/Push）

#### 10. 音声解説オプション

**改善案:**
- 5万文字を読むのは大変
- 要約版 + 音声読み上げの併用

#### 11. プレビュー機能

**改善案:**
- PDF生成前にWeb上でプレビュー
- セクション単位での確認

---

## 📊 優先順位マトリックス

| 改善項目 | 影響度 | 実装難易度 | 優先度 |
|----------|--------|------------|--------|
| 階層型メモリ設計 | 高 | 中 | 🔴 最高 |
| 3段階リカバリー | 高 | 低 | 🔴 最高 |
| バックエンドPDF | 高 | 中 | 🔴 最高 |
| Swiss Ephemeris実装 | 高 | 高 | 🔴 最高 |
| ストリーミング表示 | 中 | 低 | 🟡 高 |
| 橋渡し文自動挿入 | 中 | 低 | 🟡 高 |
| 中断・再開機能 | 中 | 中 | 🟡 高 |
| 地図連携 | 低 | 中 | 🟢 中 |
| 自動進行オプション | 低 | 中 | 🟢 中 |
| 音声解説 | 低 | 高 | ⚪ 低 |

---

## 🎯 アクションアイテム

### 即座に対応すべき項目（Week 1-2）

1. **Swiss Ephemerisの実装方針決定**
   - PySwissEph + Docker環境での検証
   - サビアンシンボル計算（度数+1）のテスト

2. **JSONマスターデータの完成**
   - 固定テキスト部分の抽出
   - 全15ステップ分の構造化

3. **文字数リカバリーロジックの実装**
   - 3段階システムのプロトタイプ

### 短期対応項目（Week 3-4）

4. **ストリーミング表示の実装**
5. **階層型メモリ設計の実装**
6. **PDF生成エンジンの選定とテスト**

### 中期対応項目（Week 5-6）

7. **UI実装（フロントエンド）**
8. **中断・再開機能**
9. **地図連携**

---

## 📝 ダイアログで見落とされた可能性のある点

### 1. エラーハンドリング
- 出生時間が未来の日付の場合
- 存在しない都市名の場合
- API障害時のフォールバック

### 2. セキュリティ
- 個人情報（生年月日、出生地）の取り扱い
- データ保持期間の明示
- GDPRなどのプライバシー規制対応

### 3. 料金体系
- 1回いくらで提供するか
- 月額サブスクリプションか
- AI APIコストの回収方法

### 4. 法的免責事項
- 「占星術は参考情報であり、人生の決定は自己責任」
- 未来予測の免責

### 5. 多言語対応
- 日本語以外の需要はあるか
- 将来の拡張性

### 6. アクセシビリティ
- スクリーンリーダー対応
- カラーコントラスト

---

*作成日: 2024年*
*このドキュメントは開発チーム向けの参考資料です*
